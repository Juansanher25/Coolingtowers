<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torres de Enfriamiento - Módulo de Ingeniería</title>
    
    <!-- 1. Cargar Tailwind CSS (Estilos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Cargar Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 3. Fuentes Google -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3 { font-family: 'Merriweather', serif; }
        
        /* Animaciones suaves */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Utilidades */
        .hidden { display: none !important; }
        
        /* Estilos específicos para inputs numéricos */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ================= PANTALLA DE PORTADA ================= -->
    <div id="cover-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 text-white">
        <!-- Imagen de Fondo -->
        <div class="absolute inset-0 z-0 bg-cover bg-center opacity-40"
             style="background-image: url('https://raw.githubusercontent.com/Juansanher25/Coolingtowers/main/Didcot_power_station_cooling_tower_zootalures.jpg');">
        </div>

        <div class="relative z-10 max-w-5xl mx-auto px-6 text-center space-y-8 fade-in">
            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-blue-500/20 border border-blue-400/30 text-blue-200 text-sm font-medium backdrop-blur-sm">
                <i data-lucide="activity" class="w-4 h-4"></i> Módulo de Ingeniería Asistido por IA
            </div>
            
            <h1 class="text-5xl md:text-7xl font-extrabold tracking-tight text-white drop-shadow-lg">
                Torres de Enfriamiento
            </h1>
            <h2 class="text-2xl md:text-3xl font-light text-slate-300">
                Simulación, Cálculo y Diagnóstico
            </h2>

            <div class="flex flex-col md:flex-row justify-center items-center gap-8 py-8 border-t border-b border-white/10 mt-8">
                <div class="flex items-center gap-3">
                    <i data-lucide="user" class="w-6 h-6 text-blue-400"></i>
                    <div class="text-left">
                        <p class="text-xs text-blue-400 uppercase font-bold">Autor</p>
                        <p class="font-medium">Ph.D. (c) Juan Andrés Sandoval</p>
                    </div>
                </div>
                <div class="hidden md:block w-px h-12 bg-slate-600"></div>
                <div class="flex items-center gap-3">
                    <i data-lucide="book-open" class="w-6 h-6 text-emerald-400"></i>
                    <div class="text-left">
                        <p class="text-xs text-emerald-400 uppercase font-bold">Curso</p>
                        <p class="font-medium">Transferencia de Calor II</p>
                    </div>
                </div>
                <div class="hidden md:block w-px h-12 bg-slate-600"></div>
                <div class="flex items-center gap-3">
                    <i data-lucide="calendar" class="w-6 h-6 text-amber-400"></i>
                    <div class="text-left">
                        <p class="text-xs text-amber-400 uppercase font-bold">Año</p>
                        <p class="font-medium">2025</p>
                    </div>
                </div>
            </div>

            <button onclick="startApp()" class="group relative inline-flex items-center gap-3 px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white text-lg font-bold rounded-full transition-all shadow-[0_0_20px_rgba(37,99,235,0.5)] hover:-translate-y-1">
                Iniciar Módulo <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- ================= PANTALLA DE APLICACIÓN ================= -->
    <div id="app-screen" class="hidden min-h-screen p-4 md:p-8 fade-in">
        <div class="max-w-6xl mx-auto space-y-6">
            
            <!-- Header -->
            <header class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-blue-600 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                        <i data-lucide="activity" class="text-blue-600"></i>
                        Módulo de Ingeniería: Torres de Enfriamiento
                    </h1>
                    <p class="text-slate-500 text-sm mt-1">Ph.D. (c) Juan Andrés Sandoval Herrera | Transferencia de Calor</p>
                </div>
                <button onclick="showCover()" class="text-sm text-blue-600 hover:text-blue-800 font-medium underline">
                    Volver a Portada
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- COLUMNA IZQUIERDA: INPUTS -->
                <div class="lg:col-span-1 space-y-6">
                    
                    <!-- Panel Agua -->
                    <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="settings" class="w-4 h-4 text-slate-500"></i> Parámetros de Operación
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Presión Atmosférica (kPa)</label>
                                <input type="number" id="patm" value="101.325" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                                <span class="text-[10px] text-slate-400">1 atm ≈ 101.3 kPa | Bogotá ≈ 74 kPa</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Flujo Agua (kg/s)</label>
                                    <input type="number" id="flowRate" value="15" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cp Agua</label>
                                    <input type="text" id="cpDisplay" disabled value="-" class="w-full p-2 border rounded bg-slate-100 text-slate-500 text-xs font-mono">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">T. Entrada (°C)</label>
                                    <input type="number" id="tIn" value="45" class="w-full p-2 border border-red-200 bg-red-50 text-red-700 font-bold rounded focus:ring-2 focus:ring-red-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">T. Salida (°C)</label>
                                    <input type="number" id="tOut" value="30" class="w-full p-2 border border-blue-200 bg-blue-50 text-blue-700 font-bold rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Panel Aire -->
                    <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="wind" class="w-4 h-4 text-slate-500"></i> Aire y Psicrometría
                        </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">T. Bulbo Seco (°C)</label>
                                    <input type="number" id="tdb" value="30" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">% Humedad Rel.</label>
                                    <input type="number" id="rh" value="60" class="w-full p-2 border rounded bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                            </div>
                            <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-lg">
                                <label class="block text-xs font-bold text-indigo-800 uppercase mb-1">Estimación T. Salida Aire (°C)</label>
                                <input type="number" id="tAirOutEst" value="38" class="w-full p-2 border border-indigo-200 rounded bg-white font-bold text-indigo-600 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <p class="text-[10px] text-indigo-400 mt-1">Requerido para cálculo de flujo de aire.</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Panel Química -->
                    <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="droplets" class="w-4 h-4 text-slate-500"></i> Química del Agua
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">SDT Torre</label>
                                <input type="number" id="tdsTower" value="1200" class="w-full p-2 border rounded bg-slate-50">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">SDT Reposición</label>
                                <input type="number" id="tdsMakeup" value="300" class="w-full p-2 border rounded bg-slate-50">
                            </div>
                        </div>
                    </section>

                    <button onclick="calculate()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2 transform active:scale-95">
                        <i data-lucide="calculator" class="w-5 h-5"></i> Calcular y Diagnosticar
                    </button>
                </div>

                <!-- COLUMNA DERECHA: RESULTADOS -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- Estado Inicial -->
                    <div id="empty-state" class="h-full flex flex-col items-center justify-center text-slate-400 bg-white rounded-xl border-2 border-dashed border-slate-300 min-h-[400px]">
                        <i data-lucide="activity" class="w-12 h-12 mb-4 opacity-50 text-blue-300"></i>
                        <p class="text-lg font-medium">Sistema Listo</p>
                        <p class="text-sm">Ingrese parámetros y presione Calcular.</p>
                    </div>

                    <!-- Contenedor Resultados -->
                    <div id="results-container" class="hidden space-y-6">
                        
                        <!-- TARJETAS DESTACADAS (Potencia y Aire) -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2 border-b pb-2">
                                <i data-lucide="zap" class="w-5 h-5 text-blue-600"></i> Resultados de Diseño
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                                <!-- Potencia -->
                                <div class="bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden group">
                                    <div class="relative z-10">
                                        <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">Potencia Térmica (Q)</p>
                                        <div class="flex items-baseline gap-2">
                                            <span id="res-kw" class="text-3xl font-bold">0.0</span>
                                            <span class="text-sm opacity-80">kW</span>
                                        </div>
                                        <div class="mt-2 bg-white/20 inline-block px-3 py-1 rounded text-sm font-semibold backdrop-blur-sm">
                                            <span id="res-tr">0.0</span> TR
                                        </div>
                                    </div>
                                    <i data-lucide="zap" class="absolute -bottom-4 -right-4 w-24 h-24 text-white opacity-10 group-hover:opacity-20 transition-opacity"></i>
                                </div>

                                <!-- Aire -->
                                <div class="bg-gradient-to-br from-cyan-500 to-blue-500 rounded-xl p-5 text-white shadow-lg relative overflow-hidden group">
                                    <div class="relative z-10">
                                        <p class="text-cyan-100 text-xs font-bold uppercase tracking-wider mb-1">Flujo Másico Aire Requerido</p>
                                        <div class="flex items-baseline gap-2">
                                            <span id="res-air" class="text-3xl font-bold">0.00</span>
                                            <span class="text-sm opacity-80">kg/s</span>
                                        </div>
                                        <div class="mt-2 text-xs opacity-90">
                                            Δh Aire: <span id="res-delta-h">0.0</span> kJ/kg
                                        </div>
                                    </div>
                                    <i data-lucide="fan" class="absolute -bottom-4 -right-4 w-24 h-24 text-white opacity-10 group-hover:opacity-20 transition-opacity"></i>
                                </div>
                            </div>
                        </div>

                        <!-- INDICADORES -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <p class="text-xs text-slate-400 font-bold uppercase">Bulbo Húmedo</p>
                                <p class="text-xl font-bold text-slate-700"><span id="res-twb">0.0</span> °C</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <p class="text-xs text-slate-400 font-bold uppercase">Aproximación</p>
                                <p class="text-xl font-bold text-slate-700"><span id="res-appr">0.0</span> °C</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <p class="text-xs text-slate-400 font-bold uppercase">Rango</p>
                                <p class="text-xl font-bold text-slate-700"><span id="res-range">0.0</span> °C</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <p class="text-xs text-slate-400 font-bold uppercase">Efectividad</p>
                                <p class="text-xl font-bold text-emerald-600"><span id="res-eff">0.0</span> %</p>
                            </div>
                        </div>

                        <!-- BALANCE AGUA -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="bg-slate-50 px-6 py-3 border-b border-slate-200">
                                <h3 class="font-bold text-slate-700 text-sm">Balance de Masa (Agua)</h3>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div class="bg-white p-3 rounded border border-slate-100 shadow-sm">
                                    <p class="text-xs text-slate-400 font-bold uppercase">Reposición</p>
                                    <p class="text-2xl font-bold text-blue-600"><span id="res-makeup">0.00</span> <span class="text-xs font-normal text-slate-500">kg/s</span></p>
                                </div>
                                <div class="bg-white p-3 rounded border border-slate-100 shadow-sm">
                                    <p class="text-xs text-slate-400 font-bold uppercase">Evaporación</p>
                                    <p class="text-2xl font-bold text-sky-500"><span id="res-evap">0.00</span> <span class="text-xs font-normal text-slate-500">kg/s</span></p>
                                </div>
                                <div class="bg-white p-3 rounded border border-slate-100 shadow-sm">
                                    <p class="text-xs text-slate-400 font-bold uppercase">Purga</p>
                                    <p class="text-2xl font-bold text-amber-500"><span id="res-blow">0.00</span> <span class="text-xs font-normal text-slate-500">kg/s</span></p>
                                </div>
                            </div>
                            <div class="px-6 pb-4 text-center text-xs text-slate-400">
                                COC Calculado: <span id="res-coc" class="font-bold">0.0</span>
                            </div>
                        </div>

                        <!-- DIAGNOSTICO -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200">
                            <div class="bg-slate-800 px-6 py-4 rounded-t-xl">
                                <h3 class="font-bold text-white flex items-center gap-2">
                                    <i data-lucide="info" class="text-blue-300 w-5 h-5"></i> Diagnóstico
                                </h3>
                            </div>
                            <div id="diagnostics-list" class="p-6 space-y-3">
                                <!-- JS inyectará aquí -->
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= LOGICA JAVASCRIPT ================= -->
    <script>
        // Inicializar Iconos al cargar
        lucide.createIcons();

        // NAVEGACION
        function startApp() {
            document.getElementById('cover-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
        }

        function showCover() {
            document.getElementById('cover-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }

        // CONSTANTES Y FORMULAS
        const LATENT_HEAT = 2430; 

        function getWaterCp(t) {
            const A = 4.2174, B = -0.005618, C = 0.0001299, D = -0.000001152;
            return A + (B * t) + (C * t * t) + (D * t * t * t);
        }

        function getSatVapPressure(T) {
            return 0.61078 * Math.exp((17.27 * T) / (T + 237.3));
        }

        function getHumidityRatio(Pv, P_kPa) {
            return 0.622 * Pv / (P_kPa - Pv);
        }

        function getAirEnthalpy(T, W) {
            return 1.006 * T + W * (2501 + 1.86 * T);
        }

        function calculateWetBulb(Tdb, P_kPa, humidityInput) {
            const Psat = getSatVapPressure(Tdb);
            const Pv = Psat * (humidityInput / 100);
            
            let low = -20, high = Tdb, Twb_guess = Tdb;
            for (let i = 0; i < 50; i++) {
                Twb_guess = (low + high) / 2;
                const Psat_wb = getSatVapPressure(Twb_guess);
                const bracketTerm = 0.00066 * (1 + 0.00115 * Twb_guess) * P_kPa * (Tdb - Twb_guess);
                const Pv_iter = Psat_wb - bracketTerm;
                if (Pv_iter > Pv) high = Twb_guess; else low = Twb_guess;
            }
            return { tWb: Twb_guess, Pv_actual: Pv };
        }

        // FUNCION PRINCIPAL DE CALCULO
        function calculate() {
            // Leer Inputs
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            
            const patm = getVal('patm');
            const flowRate = getVal('flowRate');
            const tIn = getVal('tIn');
            const tOut = getVal('tOut');
            const tdb = getVal('tdb');
            const rh = getVal('rh');
            const tAirOutEst = getVal('tAirOutEst');
            const tdsTower = getVal('tdsTower');
            const tdsMakeup = getVal('tdsMakeup');

            // 1. Propiedades Agua
            const tAvg = (tIn + tOut) / 2;
            const cp = getWaterCp(tAvg);
            document.getElementById('cpDisplay').value = cp.toFixed(4) + " kJ/kg°C";

            // 2. Psicrometría Entrada
            const { tWb, Pv_actual } = calculateWetBulb(tdb, patm, rh);
            const W_in = getHumidityRatio(Pv_actual, patm);
            const h_air_in = getAirEnthalpy(tdb, W_in);

            // 3. Potencia Térmica
            const range = tIn - tOut;
            const approach = tOut - tWb;
            const efficiency = (range / (range + approach)) * 100;
            
            const capacityKW = flowRate * cp * range;
            const capacityTR = capacityKW / 3.517;

            // 4. Flujo Aire
            const Psat_out = getSatVapPressure(tAirOutEst);
            const W_out = getHumidityRatio(Psat_out, patm);
            const h_air_out = getAirEnthalpy(tAirOutEst, W_out);
            const delta_h = h_air_out - h_air_in;
            const airMassFlow = delta_h > 0 ? capacityKW / delta_h : 0;

            // 5. Balance Agua
            const coc = tdsMakeup > 0 ? tdsTower / tdsMakeup : 0;
            const evapLoss = capacityKW / LATENT_HEAT;
            let makeupWater = 0, blowdownTotal = 0;
            if (coc > 1) {
                makeupWater = evapLoss * (coc / (coc - 1));
                blowdownTotal = makeupWater - evapLoss;
            }

            // --- ACTUALIZAR UI ---
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');

            // Tarjetas Grandes
            document.getElementById('res-kw').textContent = capacityKW.toFixed(1);
            document.getElementById('res-tr').textContent = capacityTR.toFixed(1);
            document.getElementById('res-air').textContent = airMassFlow.toFixed(2);
            document.getElementById('res-delta-h').textContent = delta_h.toFixed(1);

            // Indicadores
            document.getElementById('res-twb').textContent = tWb.toFixed(1);
            document.getElementById('res-appr').textContent = approach.toFixed(1);
            document.getElementById('res-range').textContent = range.toFixed(1);
            document.getElementById('res-eff').textContent = efficiency.toFixed(1);

            // Balance
            document.getElementById('res-makeup').textContent = makeupWater.toFixed(3);
            document.getElementById('res-evap').textContent = evapLoss.toFixed(3);
            document.getElementById('res-blow').textContent = blowdownTotal.toFixed(3);
            document.getElementById('res-coc').textContent = coc.toFixed(1);

            // Diagnósticos
            const list = document.getElementById('diagnostics-list');
            list.innerHTML = ''; // Limpiar

            const addDiag = (msg, type) => {
                const styles = {
                    error: 'bg-red-50 border-red-500 text-red-800',
                    warning: 'bg-amber-50 border-amber-500 text-amber-800',
                    success: 'bg-emerald-50 border-emerald-500 text-emerald-800',
                    info: 'bg-blue-50 border-blue-500 text-blue-800'
                };
                const div = document.createElement('div');
                div.className = `p-4 rounded-lg border-l-4 flex gap-3 ${styles[type]}`;
                div.innerHTML = `<div class="mt-1"><i data-lucide="${type === 'success' ? 'check-circle' : 'alert-triangle'}" class="w-5 h-5"></i></div><p class="text-sm font-medium">${msg}</p>`;
                list.appendChild(div);
            };

            if (approach < 0) addDiag('Error Físico: T. Salida menor que Bulbo Húmedo.', 'error');
            if (delta_h <= 0) addDiag('Error Aire: Entalpía Salida < Entrada. Aumente la T. Salida Aire Estimada.', 'error');
            
            if (efficiency > 85) addDiag('Alta Efectividad: Operación térmica excelente.', 'success');
            else if (efficiency < 40) addDiag('Baja Efectividad: Posible mala distribución o subcarga.', 'warning');
            
            if (approach <= 3 && approach > 0) addDiag('Aproximación Ideal.', 'success');
            else if (approach > 5) addDiag('Aproximación Alta: Dificultad para transferir calor.', 'warning');

            if (coc < 2) addDiag('COC Bajo (<2): Desperdicio de agua.', 'warning');
            else if (coc > 7) addDiag('COC Alto (>7): Riesgo de incrustación.', 'warning');
            else addDiag('Química Balanceada.', 'success');

            // Refrescar iconos nuevos
            lucide.createIcons();
        }
    </script>
</body>
</html>
